# =============================================================================
# AB Bank Notification Gateway — Application Configuration
#
# Every value can be overridden by:
#   Environment variable  (UPPER_SNAKE_CASE — Typesafe Config substitution)
#   JVM system property   (-Dkey=value)
#
# Sensitive secrets (API keys, auth tokens) should ALWAYS be injected via
# environment variables or a secrets manager — never committed to source.
# =============================================================================

kafka {
  bootstrap-servers   = "localhost:9092"
  bootstrap-servers   = ${?KAFKA_BOOTSTRAP_SERVERS}

  consumer {
    group-id          = "notification-gateway-service"
    group-id          = ${?KAFKA_CONSUMER_GROUP_ID}

    auto-offset-reset = "earliest"
    max-poll-records  = 50
    session-timeout-ms  = 30000
    heartbeat-interval-ms = 10000
  }

  # All notification topics produced by abbank-streams
  topics = [
    "abbank.notifications.fraud-alerts",
    "abbank.notifications.high-value-alerts",
    "abbank.notifications.balance-updates",
    "abbank.notifications.dormancy-alerts",
    "abbank.notifications.daily-spend"
  ]
}

# =============================================================================
# CHANNEL PROVIDERS
# Enable/disable each provider independently. If a channel is BOTH (email+SMS),
# both enabled providers are invoked in parallel.
# =============================================================================

channels {

  # ── EMAIL ──────────────────────────────────────────────────────────────────
  email {
    # "sendgrid" | "ses" | "mailersend" | "postmark" — first enabled wins
    # Set multiple to "enabled = true" to use a primary + automatic fallback
    providers = [
      {
        name    = "sendgrid"
        enabled = true
        enabled = ${?EMAIL_SENDGRID_ENABLED}
        api-key = ""
        api-key = ${?SENDGRID_API_KEY}
        from    = "noreply@abbank.com"
        from    = ${?EMAIL_FROM_ADDRESS}
        # Optional: reply-to address for customer responses
        reply-to = "support@abbank.com"
        reply-to = ${?EMAIL_REPLY_TO}
      },
      {
        name    = "ses"
        enabled = false
        enabled = ${?EMAIL_SES_ENABLED}
        # SES uses the AWS SDK credential chain (env vars, instance profile, etc.)
        # AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION must be set externally
        region  = "eu-west-1"
        region  = ${?AWS_REGION}
        from    = "noreply@abbank.com"
        from    = ${?EMAIL_FROM_ADDRESS}
        # SES requires the from address to be verified in the AWS console
      },
      {
        name    = "mailersend"
        enabled = false
        enabled = ${?EMAIL_MAILERSEND_ENABLED}
        api-key = ""
        api-key = ${?MAILERSEND_API_KEY}
        from    = "noreply@abbank.com"
        from    = ${?EMAIL_FROM_ADDRESS}
      },
      {
        name    = "postmark"
        enabled = false
        enabled = ${?EMAIL_POSTMARK_ENABLED}
        server-token = ""
        server-token = ${?POSTMARK_SERVER_TOKEN}
        from    = "noreply@abbank.com"
        from    = ${?EMAIL_FROM_ADDRESS}
        # Postmark requires a verified sender signature
        message-stream = "outbound"
        message-stream = ${?POSTMARK_MESSAGE_STREAM}
      }
    ]
  }

  # ── SMS ────────────────────────────────────────────────────────────────────
  sms {
    # "twilio" | "africas-talking" | "termii" — first enabled wins
    # termii is a Nigerian provider with excellent local delivery rates
    providers = [
      {
        name         = "africas-talking"
        enabled      = true
        enabled      = ${?SMS_AT_ENABLED}
        api-key      = ""
        api-key      = ${?AFRICAS_TALKING_API_KEY}
        username     = ""
        username     = ${?AFRICAS_TALKING_USERNAME}
        sender-id    = "ABBANK"
        sender-id    = ${?SMS_SENDER_ID}
        # sandbox = true uses the AT sandbox environment for testing
        sandbox      = false
        sandbox      = ${?AFRICAS_TALKING_SANDBOX}
      },
      {
        name         = "twilio"
        enabled      = false
        enabled      = ${?SMS_TWILIO_ENABLED}
        account-sid  = ""
        account-sid  = ${?TWILIO_ACCOUNT_SID}
        auth-token   = ""
        auth-token   = ${?TWILIO_AUTH_TOKEN}
        from-number  = ""
        from-number  = ${?TWILIO_FROM_NUMBER}
      },
      {
        name         = "termii"
        enabled      = false
        enabled      = ${?SMS_TERMII_ENABLED}
        api-key      = ""
        api-key      = ${?TERMII_API_KEY}
        sender-id    = "ABBANK"
        sender-id    = ${?SMS_SENDER_ID}
        channel      = "generic"   # "generic" | "dnd" | "WhatsApp"
      }
    ]
  }

  # ── PUSH / IN-APP (optional future channel) ────────────────────────────────
  # push {
  #   provider = "firebase"
  #   enabled  = false
  # }
}

# =============================================================================
# ROUTING RULES
# Controls which severity/type combinations get sent to which channels.
# =============================================================================
routing {
  # CRITICAL and HIGH alerts always use BOTH channels regardless of event channel field
  force-both-on-severity = ["CRITICAL", "HIGH"]

  # Per-type overrides (optional). Uncomment to restrict a type to a single channel.
  # type-overrides {
  #   DORMANCY_ALERT   = "EMAIL"
  #   DAILY_SPEND_SUMMARY = "EMAIL"
  # }
}

# =============================================================================
# CUSTOMER LOOKUP
# The gateway needs to resolve accountId → email/phone.
# This should point to the customer profile service or a read-model.
# For demo/MVP use the static mock resolver.
# =============================================================================
customer-resolver {
  # "mock" | "http"
  type = "mock"
  type = ${?CUSTOMER_RESOLVER_TYPE}

  http {
    base-url = "http://customer-service:8090"
    base-url = ${?CUSTOMER_SERVICE_URL}
    timeout-ms = 3000
  }
}

# =============================================================================
# RETRY POLICY
# Exponential back-off with jitter for transient provider failures.
# =============================================================================
retry {
  max-attempts     = 3
  max-attempts     = ${?RETRY_MAX_ATTEMPTS}
  initial-delay-ms = 500
  backoff-factor   = 2.0
  max-delay-ms     = 10000
  # Dead-letter behaviour: "log" | "kafka" (requires dlq-topic)
  on-exhausted     = "log"
  on-exhausted     = ${?RETRY_ON_EXHAUSTED}
  dlq-topic        = "abbank.notifications.dlq"
}

# =============================================================================
# HEALTH CHECK SERVER
# =============================================================================
health {
  port = 8089
  port = ${?HEALTH_PORT}
}
